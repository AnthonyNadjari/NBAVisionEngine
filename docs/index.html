<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NBAVision Engine — Control Center</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg-deep: #0a0a0f;
      --bg-card: rgba(18, 18, 28, 0.85);
      --bg-card-hover: rgba(28, 28, 42, 0.9);
      --accent: #f97316;
      --accent-dim: #ea580c;
      --accent-glow: rgba(249, 115, 22, 0.4);
      --court: #1a1a2e;
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --success: #22c55e;
      --warning: #eab308;
      --error: #ef4444;
      --border: rgba(249, 115, 22, 0.25);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Rajdhani', sans-serif;
      background: var(--bg-deep);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Court lines background */
    .court-bg {
      position: fixed;
      inset: 0;
      background:
        linear-gradient(180deg, transparent 0%, var(--court) 50%, transparent 100%),
        repeating-linear-gradient(
          90deg,
          transparent 0px,
          transparent 99px,
          rgba(249, 115, 22, 0.03) 99px,
          rgba(249, 115, 22, 0.03) 100px
        ),
        radial-gradient(ellipse 80% 50% at 50% 120%, var(--accent-glow) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    .container {
      position: relative;
      z-index: 1;
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem 1.5rem 4rem;
    }

    header {
      text-align: center;
      margin-bottom: 2.5rem;
      padding: 1.5rem;
    }
    .logo {
      font-family: 'Orbitron', sans-serif;
      font-weight: 900;
      font-size: clamp(1.8rem, 5vw, 2.8rem);
      letter-spacing: 0.15em;
      background: linear-gradient(135deg, #fff 0%, var(--accent) 50%, #fff 100%);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: shine 4s ease-in-out infinite;
    }
    @keyframes shine {
      0%, 100% { background-position: 0% center; }
      50% { background-position: 100% center; }
    }
    .tagline {
      font-family: 'Orbitron', sans-serif;
      font-weight: 400;
      font-size: 0.75rem;
      letter-spacing: 0.4em;
      text-transform: uppercase;
      color: var(--accent);
      margin-top: 0.5rem;
      opacity: 0.9;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.25rem;
      backdrop-filter: blur(12px);
      transition: background 0.2s, border-color 0.2s, box-shadow 0.2s;
    }
    .card:hover { background: var(--bg-card-hover); border-color: rgba(249, 115, 22, 0.35); }
    .card-title {
      font-family: 'Orbitron', sans-serif;
      font-weight: 600;
      font-size: 0.9rem;
      letter-spacing: 0.1em;
      color: var(--accent);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .card-title::before {
      content: '';
      width: 4px;
      height: 1em;
      background: var(--accent);
      border-radius: 2px;
    }

    .status-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .status-badge {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.75rem;
      padding: 0.35rem 0.75rem;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .status-badge.queued   { background: var(--text-muted); color: var(--bg-deep); }
    .status-badge.in_progress { background: var(--accent); color: var(--bg-deep); animation: pulse 1.5s ease-in-out infinite; }
    .status-badge.completed { background: var(--success); color: var(--bg-deep); }
    .status-badge.failure  { background: var(--error); color: #fff; }
    .status-badge.cancelled { background: var(--text-muted); color: var(--bg-deep); }
    .status-badge.idle { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.85; } }

    .stat {
      font-size: 0.95rem;
      color: var(--text-muted);
    }
    .stat strong { color: var(--text); }

    .btn {
      font-family: 'Orbitron', sans-serif;
      font-weight: 600;
      font-size: 0.8rem;
      letter-spacing: 0.08em;
      padding: 0.65rem 1.25rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dim) 100%);
      color: #fff;
      box-shadow: 0 4px 20px var(--accent-glow);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 28px var(--accent-glow);
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .btn-secondary {
      background: transparent;
      color: var(--accent);
      border: 1px solid var(--accent);
    }
    .btn-secondary:hover { background: rgba(249, 115, 22, 0.15); }

    .token-row {
      display: flex;
      gap: 0.75rem;
      margin-top: 0.75rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .token-row .btn { flex: 0 0 auto; }
    .token-row input { flex: 1; min-width: 180px; padding: 0.5rem 0.75rem; background: rgba(10,10,15,0.6); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.85rem; }
    .token-row input:focus { outline: none; border-color: var(--accent); }
    .connected-badge { font-size: 0.75rem; color: var(--success); display: inline-flex; align-items: center; gap: 0.35rem; }
    .connected-badge::before { content: ''; width: 6px; height: 6px; border-radius: 50%; background: var(--success); }

    .help-text {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
      line-height: 1.5;
    }
    .help-text a { color: var(--accent); text-decoration: none; }
    .help-text a:hover { text-decoration: underline; }

    .section-toggle {
      width: 100%;
      text-align: left;
      font-family: 'Orbitron', sans-serif;
      font-size: 0.8rem;
      letter-spacing: 0.05em;
      color: var(--accent);
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem 0;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .section-toggle:hover { color: #fff; }
    .section-toggle::after { content: '▼'; font-size: 0.65rem; transition: transform 0.2s; }
    .section-toggle.open::after { transform: rotate(-180deg); }
    .section-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    .section-content.open { max-height: 1200px; }
    .section-content ol, .section-content ul {
      margin: 0.5rem 0 1rem 1.25rem;
      color: var(--text-muted);
      font-size: 0.9rem;
      line-height: 1.7;
    }

    .live-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 10px var(--success);
      animation: live 2s ease-in-out infinite;
    }
    @keyframes live { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .run-details {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    .run-details a { color: var(--accent); }
    .error-msg { color: var(--error); font-size: 0.9rem; margin-top: 0.5rem; }
  </style>
</head>
<body>
  <div class="court-bg"></div>
  <div class="container">
    <header>
      <h1 class="logo">NBAVision Engine</h1>
      <p class="tagline">Control Center · Real-time</p>
    </header>

    <section class="card">
      <h2 class="card-title"><span class="live-dot"></span> Live status</h2>
      <div class="status-row">
        <span id="statusBadge" class="status-badge idle">—</span>
        <span id="statusText" class="stat">Loading last run…</span>
      </div>
      <div id="runDetails" class="run-details" style="display: none;"></div>
      <div class="token-row">
        <button type="button" class="btn btn-primary" id="refreshBtn">Refresh status</button>
      </div>
      <p class="help-text">
        Add a GitHub token in Settings to trigger runs and see live status.
      </p>
      <p id="statusError" class="error-msg" style="display: none;"></p>
    </section>

    <section class="card">
      <h2 class="card-title">Trigger run</h2>
      <div class="token-row">
        <button type="button" class="btn btn-primary" id="triggerBtn" disabled>Start engine run</button>
      </div>
      <p class="help-text" id="triggerHelp">
        Save a token in Settings to start a run. Run can take up to 6 hours; status updates above.
      </p>
      <p class="help-text" style="margin-top: 0.5rem; font-size: 0.8rem; opacity: 0.9;">
        <strong>What happens?</strong> This starts the NBAVision workflow on GitHub Actions: the bot scrapes NBA tweets, picks the best ones, generates replies with AI (Groq), and posts them on X. You can watch progress in Live status.
      </p>
      <p id="triggerError" class="error-msg" style="display: none;"></p>
      <p id="triggerSuccess" style="color: var(--success); font-size: 0.9rem; margin-top: 0.5rem; display: none;"></p>
    </section>

    <section class="card">
      <button type="button" class="section-toggle" id="settingsToggle" aria-expanded="false">Settings — GitHub token</button>
      <div id="settingsSection" class="section-content">
        <p class="help-text" style="margin-bottom: 0.75rem;">Paste a <a href="https://github.com/settings/tokens/new?scopes=repo&amp;description=NBAVision" target="_blank" rel="noopener">Personal Access Token</a> (repo scope). Stored in this browser session only.</p>
        <div class="token-row">
          <input type="password" id="tokenInput" placeholder="ghp_..." autocomplete="off" />
          <button type="button" class="btn btn-primary" id="saveTokenBtn">Save</button>
          <button type="button" class="btn btn-secondary" id="clearTokenBtn">Clear</button>
        </div>
        <p id="settingsStatus" class="help-text" style="margin-top: 0.5rem;"></p>
      </div>
    </section>

    <section class="card">
      <button type="button" class="section-toggle" id="cookiesToggle" aria-expanded="false">How to export Twitter cookies</button>
      <div id="cookiesSection" class="section-content">
        <ol>
          <li>Log in to <strong>Twitter (X)</strong> in Chrome or Edge.</li>
          <li>Install a cookie export extension, e.g. <a href="https://chromewebstore.google.com/detail/cookie-editor/hlkenndednhfkekhgpnkiidkbajdkebn" target="_blank" rel="noopener">Cookie-Editor</a> or <a href="https://chromewebstore.google.com/detail/editthiscookie/fngmhnnpilhplaeedifhccceomclgfbg" target="_blank" rel="noopener">EditThisCookie</a>.</li>
          <li>Open <code>twitter.com</code> (or <code>x.com</code>), then open the extension.</li>
          <li>Export cookies as <strong>JSON</strong> (Cookie-Editor: "Export" → JSON; ensure it’s an <strong>array</strong> of objects with <code>name</code>, <code>value</code>, <code>domain</code>, <code>path</code>, etc.).</li>
          <li>Copy the full JSON array and paste it into <code>credentials.json</code> under <code>twitter_cookies</code> (project root).</li>
        </ol>
        <p class="help-text">
          The engine uses these cookies to run in headless Chrome on GitHub Actions. Do not share the JSON; treat it like a password.
        </p>
      </div>
    </section>
  </div>

  <script>
    (function() {
      const WORKFLOW_FILE = 'nbavision.yml';
      const STORAGE_KEY = 'nbavision_gh_token';

      const repo = detectRepo();
      function detectRepo() {
        const host = window.location.hostname || '';
        const path = window.location.pathname || '';
        if (host.includes('github.io')) {
          const parts = path.split('/').filter(Boolean);
          const repoName = parts[0] || 'NBAVisionEngine';
          const owner = host.replace('.github.io', '').replace('.github.dev', '');
          return { owner, repo: repoName };
        }
        return { owner: 'AnthonyNadjari', repo: 'NBAVisionEngine' };
      }

      function apiUrl(path) {
        return `https://api.github.com/repos/${repo.owner}/${repo.repo}${path}`;
      }

      function getToken() {
        return sessionStorage.getItem(STORAGE_KEY) || '';
      }
      function setToken(t) {
        if (t) sessionStorage.setItem(STORAGE_KEY, t);
        else sessionStorage.removeItem(STORAGE_KEY);
        if (tokenInput) tokenInput.value = t ? '••••••••' : '';
        updateUI();
      }

      const statusBadge = document.getElementById('statusBadge');
      const statusText = document.getElementById('statusText');
      const runDetails = document.getElementById('runDetails');
      const statusError = document.getElementById('statusError');
      const refreshBtn = document.getElementById('refreshBtn');
      const triggerBtn = document.getElementById('triggerBtn');
      const triggerError = document.getElementById('triggerError');
      const triggerSuccess = document.getElementById('triggerSuccess');
      const tokenInput = document.getElementById('tokenInput');
      const saveTokenBtn = document.getElementById('saveTokenBtn');
      const clearTokenBtn = document.getElementById('clearTokenBtn');
      const settingsStatus = document.getElementById('settingsStatus');
      const settingsToggle = document.getElementById('settingsToggle');
      const settingsSection = document.getElementById('settingsSection');
      const actionsLink = document.getElementById('actionsLink');
      const cookiesToggle = document.getElementById('cookiesToggle');
      const cookiesSection = document.getElementById('cookiesSection');

      function updateUI() {
        var hasToken = !!getToken();
        if (triggerBtn) triggerBtn.disabled = !hasToken;
        if (settingsStatus) settingsStatus.innerHTML = hasToken ? '<span class="connected-badge">Connected</span>' : '';
      }

      if (actionsLink) actionsLink.href = 'https://github.com/' + repo.owner + '/' + repo.repo + '/actions';

      if (settingsToggle && settingsSection) settingsToggle.addEventListener('click', function() {
        var open = settingsSection.classList.toggle('open');
        settingsToggle.classList.toggle('open', open);
        settingsToggle.setAttribute('aria-expanded', open);
      });

      if (saveTokenBtn && tokenInput) saveTokenBtn.addEventListener('click', function() {
        var t = tokenInput.value.trim();
        if (t && t !== '••••••••') { setToken(t); if (settingsStatus) settingsStatus.innerHTML = '<span class="connected-badge">Saved</span>'; statusError.style.display = 'none'; fetchStatus(); }
      });
      if (clearTokenBtn) clearTokenBtn.addEventListener('click', function() {
        setToken(''); if (settingsStatus) settingsStatus.textContent = 'Cleared.'; setStatus('idle', 'Add a token in Settings to see status and trigger runs.'); runDetails.style.display = 'none';
      });

      cookiesToggle.addEventListener('click', function() {
        var open = cookiesSection.classList.toggle('open');
        cookiesToggle.classList.toggle('open', open);
        cookiesToggle.setAttribute('aria-expanded', open);
      });

      refreshBtn.addEventListener('click', function() {
        statusError.style.display = 'none';
        fetchStatus();
      });

      triggerBtn.addEventListener('click', function() {
        triggerError.style.display = 'none';
        triggerSuccess.style.display = 'none';
        var token = getToken();
        if (!token) return;
        triggerBtn.disabled = true;
        fetch(apiUrl('/actions/workflows/' + WORKFLOW_FILE + '/dispatches'), {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ ref: 'main' })
        })
          .then(function(res) {
            if (res.status === 204) {
              triggerSuccess.textContent = 'Run started. Status will update above.';
              triggerSuccess.style.display = 'block';
              setTimeout(fetchStatus, 2000);
              pollUntilDone();
            } else {
              return res.json().then(function(j) { throw new Error(j.message || 'Trigger failed'); });
            }
          })
          .catch(function(err) {
            triggerError.textContent = err.message || 'Trigger failed.';
            triggerError.style.display = 'block';
          })
          .finally(function() { triggerBtn.disabled = false; });
      });

      function setStatus(status, text, detailsHtml) {
        statusBadge.className = 'status-badge ' + (status || 'idle');
        statusBadge.textContent = (status || '—').replace('_', ' ');
        statusText.textContent = text || '';
        if (detailsHtml) {
          runDetails.innerHTML = detailsHtml;
          runDetails.style.display = 'block';
        } else {
          runDetails.style.display = 'none';
        }
      }

      function authHeaders() {
        var h = { 'Accept': 'application/vnd.github.v3+json' };
        var t = getToken();
        if (t) h['Authorization'] = 'Bearer ' + t;
        return h;
      }

      function fetchWithTimeout(url, opts, ms) {
        var c = new AbortController();
        var t = setTimeout(function() { c.abort(); }, ms || 15000);
        opts = opts || {};
        opts.signal = c.signal;
        return fetch(url, opts).finally(function() { clearTimeout(t); });
      }

      function fetchStatus() {
        if (statusText) statusText.textContent = 'Loading…';
        if (statusError) { statusError.textContent = ''; statusError.style.display = 'none'; }
        fetchWithTimeout(apiUrl('/actions/runs?per_page=5'), { headers: authHeaders() }, 15000)
          .then(function(res) {
            if (!res.ok) {
              if (res.status === 403 || res.status === 404) throw new Error('Need a token for this repo. Add one in Settings, then Refresh.');
              throw new Error('Could not fetch runs (' + res.status + ')');
            }
            return res.json();
          })
          .then(function(data) {
            const runs = data.workflow_runs || [];
            const nbavision = runs.find(function(r) { return (r.path || r.name || '').includes('nbavision') || (r.name && r.name.indexOf('NBAVision') !== -1); }) || runs[0];
            if (!nbavision) {
              setStatus('idle', 'No runs yet. Open Actions and click “Run workflow”.');
              return;
            }
            const status = nbavision.status;
            const conclusion = nbavision.conclusion;
            const created = nbavision.created_at ? new Date(nbavision.created_at).toLocaleString() : '';
            const url = nbavision.html_url || ('https://github.com/' + repo.owner + '/' + repo.repo + '/actions');
            var displayStatus = conclusion || status;
            var msg = 'Last run: ' + created;
            if (status === 'in_progress') msg += ' — running…';
            setStatus(displayStatus, msg, '<a href="' + url + '" target="_blank" rel="noopener">View run on GitHub →</a>');
            if (status === 'queued' || status === 'in_progress') pollUntilDone();
          })
          .catch(function(err) {
            setStatus('idle', err.name === 'AbortError' ? 'Request timed out. Try Refresh.' : '');
            if (statusError) {
              statusError.textContent = err.message || 'Failed to load status. Add a token in Settings for private repos.';
              statusError.style.display = 'block';
            }
          });
      }

      var pollTimer = null;
      function pollUntilDone() {
        if (pollTimer) clearTimeout(pollTimer);
        pollTimer = setTimeout(function() {
          fetchStatus();
          pollTimer = null;
        }, 10000);
      }

      if (tokenInput && getToken()) tokenInput.value = '••••••••';
      updateUI();
      fetchStatus();
    })();
  </script>
</body>
</html>
