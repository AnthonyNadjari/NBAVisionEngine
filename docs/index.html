<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NBAVision Engine — Control Center</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg-deep: #0a0a0f;
      --bg-card: rgba(18, 18, 28, 0.85);
      --bg-card-hover: rgba(28, 28, 42, 0.9);
      --accent: #f97316;
      --accent-dim: #ea580c;
      --accent-glow: rgba(249, 115, 22, 0.4);
      --court: #1a1a2e;
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --success: #22c55e;
      --warning: #eab308;
      --error: #ef4444;
      --border: rgba(249, 115, 22, 0.25);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Rajdhani', sans-serif; background: var(--bg-deep); color: var(--text); min-height: 100vh; overflow-x: hidden; }
    .court-bg { position: fixed; inset: 0; background: linear-gradient(180deg, transparent 0%, var(--court) 50%, transparent 100%), repeating-linear-gradient(90deg, transparent 0px, transparent 99px, rgba(249, 115, 22, 0.03) 99px, rgba(249, 115, 22, 0.03) 100px), radial-gradient(ellipse 80% 50% at 50% 120%, var(--accent-glow) 0%, transparent 50%); pointer-events: none; z-index: 0; }
    .container { position: relative; z-index: 1; max-width: 900px; margin: 0 auto; padding: 2rem 1.5rem 4rem; }
    header { text-align: center; margin-bottom: 2.5rem; padding: 1.5rem; }
    .logo { font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: clamp(1.8rem, 5vw, 2.8rem); letter-spacing: 0.15em; background: linear-gradient(135deg, #fff 0%, var(--accent) 50%, #fff 100%); background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: shine 4s ease-in-out infinite; }
    @keyframes shine { 0%, 100% { background-position: 0% center; } 50% { background-position: 100% center; } }
    .tagline { font-family: 'Orbitron', sans-serif; font-weight: 400; font-size: 0.75rem; letter-spacing: 0.4em; text-transform: uppercase; color: var(--accent); margin-top: 0.5rem; opacity: 0.9; }
    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.25rem; backdrop-filter: blur(12px); transition: background 0.2s, border-color 0.2s; }
    .card:hover { background: var(--bg-card-hover); border-color: rgba(249, 115, 22, 0.35); }
    .card-title { font-family: 'Orbitron', sans-serif; font-weight: 600; font-size: 0.9rem; letter-spacing: 0.1em; color: var(--accent); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
    .card-title::before { content: ''; width: 4px; height: 1em; background: var(--accent); border-radius: 2px; }
    .status-row { display: flex; flex-wrap: wrap; align-items: center; gap: 1rem; margin-bottom: 1rem; }
    .status-badge { font-family: 'Orbitron', sans-serif; font-size: 0.75rem; padding: 0.35rem 0.75rem; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.05em; }
    .status-badge.queued { background: var(--text-muted); color: var(--bg-deep); }
    .status-badge.in_progress { background: var(--accent); color: var(--bg-deep); animation: pulse 1.5s ease-in-out infinite; }
    .status-badge.completed { background: var(--success); color: var(--bg-deep); }
    .status-badge.failure { background: var(--error); color: #fff; }
    .status-badge.cancelled { background: var(--text-muted); color: var(--bg-deep); }
    .status-badge.idle { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.85; } }
    .stat { font-size: 0.95rem; color: var(--text-muted); }
    .btn { font-family: 'Orbitron', sans-serif; font-weight: 600; font-size: 0.8rem; letter-spacing: 0.08em; padding: 0.65rem 1.25rem; border: none; border-radius: 8px; cursor: pointer; transition: transform 0.15s, box-shadow 0.15s; }
    .btn-primary { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dim) 100%); color: #fff; box-shadow: 0 4px 20px var(--accent-glow); }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 28px var(--accent-glow); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .token-row { display: flex; gap: 0.75rem; margin-top: 0.75rem; flex-wrap: wrap; align-items: center; }
    .token-row .btn { flex: 0 0 auto; }
    .help-text { font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem; line-height: 1.5; }
    .help-text a { color: var(--accent); text-decoration: none; }
    .section-toggle { width: 100%; text-align: left; font-family: 'Orbitron', sans-serif; font-size: 0.8rem; letter-spacing: 0.05em; color: var(--accent); background: none; border: none; cursor: pointer; padding: 0.5rem 0; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
    .section-toggle:hover { color: #fff; }
    .section-toggle::after { content: '▼'; font-size: 0.65rem; transition: transform 0.2s; }
    .section-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .section-content.open { max-height: 1200px; }
    .section-content ol, .section-content ul { margin: 0.5rem 0 1rem 1.25rem; color: var(--text-muted); font-size: 0.9rem; line-height: 1.7; }
    .live-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); box-shadow: 0 0 10px var(--success); animation: live 2s ease-in-out infinite; }
    @keyframes live { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .run-details { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); font-size: 0.85rem; color: var(--text-muted); }
    .run-details a { color: var(--accent); }
    .error-msg { color: var(--error); font-size: 0.9rem; margin-top: 0.5rem; }
  </style>
</head>
<body>
  <div class="court-bg"></div>
  <div class="container">
    <header>
      <h1 class="logo">NBAVision Engine</h1>
      <p class="tagline">Control Center · Real-time</p>
    </header>

    <section class="card">
      <h2 class="card-title"><span class="live-dot"></span> Live status</h2>
      <div class="status-row">
        <span id="statusBadge" class="status-badge idle">—</span>
        <span id="statusText" class="stat">Loading…</span>
      </div>
      <div id="runDetails" class="run-details" style="display: none;"></div>
      <div class="token-row">
        <button type="button" class="btn btn-primary" id="refreshBtn">Refresh status</button>
      </div>
      <p id="statusError" class="error-msg" style="display: none;"></p>
    </section>

    <section class="card">
      <h2 class="card-title">Trigger run</h2>
      <div class="token-row">
        <button type="button" class="btn btn-primary" id="triggerBtn">Start engine run</button>
      </div>
      <p class="help-text">Run can take up to 6 hours. Status updates above.</p>
      <p class="help-text" style="margin-top: 0.5rem; font-size: 0.8rem; opacity: 0.9;"><strong>What happens?</strong> Starts the NBAVision workflow on GitHub Actions: scrapes NBA tweets, picks the best, generates replies with AI, posts on X.</p>
      <p id="triggerError" class="error-msg" style="display: none;"></p>
      <p id="triggerSuccess" style="color: var(--success); font-size: 0.9rem; margin-top: 0.5rem; display: none;"></p>
    </section>

  </div>

  <script>
    (function() {
      var WORKFLOW_FILE = 'nbavision.yml';
      var TOKEN_KEY = 'nbavision_gh_token';
      function getToken() {
        var t = sessionStorage.getItem(TOKEN_KEY) || '';
        if (t) return t;
        var h = (window.location.hash || '').replace(/^#/, '');
        var q = (window.location.search || '').replace(/^\?/, '').split('&');
        for (var i = 0; i < q.length; i++) { var p = q[i].split('='); if (p[0] === 't' || p[0] === 'token' || p[0].indexOf('ghp') === 0) { t = decodeURIComponent((p[1] || p[0]).replace(/\+/g, ' ')); break; } }
        if (!t && h.indexOf('ghp_') === 0) t = h;
        if (t) { sessionStorage.setItem(TOKEN_KEY, t); if (window.history && window.history.replaceState) window.history.replaceState('', document.title, window.location.pathname + window.location.search); }
        return t || '';
      }

      var repo = { owner: 'AnthonyNadjari', repo: 'NBAVisionEngine' };
      if (window.location.hostname && window.location.hostname.indexOf('github.io') !== -1) {
        var parts = (window.location.pathname || '').split('/').filter(Boolean);
        if (parts[0]) repo.repo = parts[0];
        repo.owner = window.location.hostname.replace('.github.io', '').replace('.github.dev', '');
      }

      function apiUrl(path) { return 'https://api.github.com/repos/' + repo.owner + '/' + repo.repo + path; }

      var statusBadge = document.getElementById('statusBadge');
      var statusText = document.getElementById('statusText');
      var runDetails = document.getElementById('runDetails');
      var statusError = document.getElementById('statusError');
      var refreshBtn = document.getElementById('refreshBtn');
      var triggerBtn = document.getElementById('triggerBtn');
      var triggerError = document.getElementById('triggerError');
      var triggerSuccess = document.getElementById('triggerSuccess');

      function setStatus(status, text, detailsHtml) {
        if (statusBadge) { statusBadge.className = 'status-badge ' + (status || 'idle'); statusBadge.textContent = (status || '—').toString().replace('_', ' '); }
        if (statusText) statusText.textContent = text || '';
        if (runDetails) {
          runDetails.innerHTML = detailsHtml || '';
          runDetails.style.display = detailsHtml ? 'block' : 'none';
        }
      }

      function fetchWithTimeout(url, opts, ms) {
        var c = new AbortController();
        var t = setTimeout(function() { c.abort(); }, ms || 15000);
        opts = opts || {}; opts.signal = c.signal;
        return fetch(url, opts).finally(function() { clearTimeout(t); });
      }

      function fetchStatus() {
        if (statusText) statusText.textContent = 'Loading…';
        if (statusError) { statusError.textContent = ''; statusError.style.display = 'none'; }
        fetchWithTimeout(apiUrl('/actions/runs?per_page=5'), {
          headers: { 'Accept': 'application/vnd.github.v3+json', 'Authorization': 'Bearer ' + getToken() }
        }, 15000)
          .then(function(res) {
            if (!res.ok) {
              if (res.status === 401) throw new Error('Token missing or invalid. Open this page once with #ghp_YOUR_TOKEN in the URL.');
              throw new Error('API ' + res.status);
            }
            return res.json();
          })
          .then(function(data) {
            var runs = (data && data.workflow_runs) || [];
            var r = runs.find(function(w) { return (w.path || w.name || '').indexOf('nbavision') !== -1 || (w.name || '').indexOf('NBAVision') !== -1; }) || runs[0];
            if (!r) {
              setStatus('idle', 'No runs yet. Click Start engine run.');
              return;
            }
            var st = r.conclusion || r.status;
            var created = r.created_at ? new Date(r.created_at).toLocaleString() : '';
            var msg = 'Last run: ' + created;
            if (r.status === 'in_progress') msg += ' — running…';
            var url = r.html_url || ('https://github.com/' + repo.owner + '/' + repo.repo + '/actions');
            setStatus(st, msg, '<a href="' + url + '" target="_blank" rel="noopener">View run on GitHub →</a>');
            if (r.status === 'queued' || r.status === 'in_progress') poll();
          })
          .catch(function(err) {
            setStatus('idle', err.name === 'AbortError' ? 'Timed out. Click Refresh.' : '');
            if (statusError) {
              statusError.textContent = err.message || 'Could not load runs.';
              statusError.style.display = 'block';
            }
          });
      }

      var pollTimer;
      function poll() {
        if (pollTimer) clearTimeout(pollTimer);
        pollTimer = setTimeout(function() { pollTimer = null; fetchStatus(); }, 10000);
      }

      refreshBtn.addEventListener('click', function() {
        if (statusText) statusText.textContent = 'Loading…';
        if (statusError) statusError.style.display = 'none';
        fetchStatus();
      });

      triggerBtn.addEventListener('click', function() {
        triggerError.style.display = 'none';
        triggerSuccess.style.display = 'none';
        triggerBtn.disabled = true;
        fetch(apiUrl('/actions/workflows/' + WORKFLOW_FILE + '/dispatches'), {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + getToken(), 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
          body: JSON.stringify({ ref: 'main' })
        })
          .then(function(res) {
            if (res.status === 204) {
              triggerSuccess.textContent = 'Run started. Status will update above.';
              triggerSuccess.style.display = 'block';
              setTimeout(fetchStatus, 1500);
              poll();
            } else return res.json().then(function(j) { throw new Error(j.message || 'Trigger failed'); });
          })
          .catch(function(err) {
            triggerError.textContent = err.message || 'Trigger failed';
            triggerError.style.display = 'block';
          })
          .finally(function() { triggerBtn.disabled = false; });
      });

      (function init() {
        if (!getToken() && triggerBtn) triggerBtn.disabled = true;
        fetchStatus();
      })();
    })();
  </script>
</body>
</html>
